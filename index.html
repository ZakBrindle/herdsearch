<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat-Herder Friend Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: auto;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #map-image {
            display: block;
            width: 100%;
            height: auto;
            background-color: #e0e0e0;
        }
        #map-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .user-marker {
            position: absolute;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.5s ease;
        }
        .user-marker img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .user-marker .name-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .floating-btn {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 900;
        }
        /* Toggle Switch CSS */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Herd Searcher</h1>
                <p class="text-gray-600">Stay connected with your crew at Beatherder festival.</p>
            </div>
            <div id="auth-container"></div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap justify-between items-center gap-4">
                <div id="user-info" class="flex items-center gap-3"></div>
                <div class="flex items-center gap-2">
                     <button id="dev-mode-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">Developer Mode</button>
                     <button id="add-friend-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Add Friend</button>
                </div>
            </div>
            
            <div id="dev-panel" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6">
                <h3 class="font-bold text-lg">Developer Mode: Drawing Area</h3>
                <p>Click on the map to draw a polygon. Click the first point again to close the shape and name it.</p>
                <button id="cancel-drawing-btn" class="mt-2 bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Cancel Drawing</button>
            </div>

            <div id="map-container">
                <img id="map-image" src="https://i.ibb.co/3yk31BFr/Beatherder-Map.png" alt="Beat-Herder Festival Map"  onerror="this.onerror=null;this.src='https://placehold.co/1200x800/cccccc/ffffff?text=Map+Not+Available';">
                <canvas id="map-canvas"></canvas>
                <div id="user-markers-container"></div>
            </div>
            
            <div class="mt-8">
                <h2 class="text-2xl font-bold mb-4">Your Squad</h2>
                <div id="squad-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </main>
        
        <div id="login-prompt" class="text-center p-8 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Welcome!</h2>
            <p class="mb-6">Please sign in to find your friends and see the map.</p>
        </div>
    </div>

    <!-- Floating Check-in Button -->
    <button id="check-in-btn" class="floating-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition hidden">
        <i class="fas fa-map-marker-alt mr-2"></i>Check In
    </button>

    <!-- Modals -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-6">Settings</h3>
            <div class="flex items-center justify-between">
                <span class="text-gray-700">Use GPS Location</span>
                <label class="switch">
                    <input type="checkbox" id="gps-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <p class="text-sm text-gray-500 mt-2">Turn off to manually check in to locations.</p>
            <div class="flex justify-end mt-6">
                <button id="settings-close" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="check-in-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Check In To a Location</h3>
            <div id="check-in-locations-list" class="max-h-80 overflow-y-auto border rounded-lg"></div>
             <div class="flex justify-end mt-4">
                <button id="check-in-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <div id="passcode-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Enter Developer Passcode</h3>
            <input type="password" id="passcode-input" class="w-full border border-gray-300 rounded-lg p-2 mb-4">
            <div class="flex justify-end gap-2">
                <button id="passcode-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="passcode-submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Submit</button>
            </div>
        </div>
    </div>

    <div id="locations-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Manage Locations</h3>
            <div id="locations-list" class="max-h-64 overflow-y-auto mb-4 border rounded-lg p-2"></div>
            <div class="flex justify-between items-center">
                <button id="add-new-location-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Add New Location</button>
                <button id="locations-close" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <div id="area-name-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Name This Area</h3>
            <input type="text" id="area-name-input" class="w-full border border-gray-300 rounded-lg p-2 mb-4" placeholder="e.g., Main Stage">
            <div class="flex justify-end gap-2">
                <button id="area-name-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="area-name-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>
    
    <div id="add-friend-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Add a Friend</h3>
            <input type="email" id="add-friend-input" class="w-full border border-gray-300 rounded-lg p-2 mb-4" placeholder="friend@example.com">
            <div class="flex justify-end gap-2">
                <button id="add-friend-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="add-friend-submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Add</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="alert-message" class="mb-4"></p>
            <button id="alert-ok" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
            <p id="confirm-message" class="mb-4"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Firebase -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, query, where, getDocs, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'festival-friend-finder';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let isDevMode = false;
        let currentPolygonPoints = [];
        let areas = {};
        let friendsData = {};
        let unsubscribes = { areas: null, user: null, friends: {} };

        // --- UI ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const loginPrompt = document.getElementById('login-prompt');
        const userInfoEl = document.getElementById('user-info');
        const mapCanvas = document.getElementById('map-canvas');
        const mapImage = document.getElementById('map-image');
        const userMarkersContainer = document.getElementById('user-markers-container');
        const squadList = document.getElementById('squad-list');
        const devPanel = document.getElementById('dev-panel');
        const checkInBtn = document.getElementById('check-in-btn');
        const gpsToggle = document.getElementById('gps-toggle');

        const ctx = mapCanvas.getContext('2d');

        // --- AUTHENTICATION ---
        const googleProvider = new GoogleAuthProvider();

        const signIn = async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error("Error signing in with Google:", error);
                showAlert(`An error occurred during sign-in: ${error.message}`);
            }
        };

        const logOut = async () => {
            await signOut(auth);
            window.location.reload(); 
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await setupUser(user);
                showAppUI(user);
                attachListeners();
            } else {
                currentUser = null;
                showLoginUI();
                cleanupListeners();
            }
        });
        
        const attemptInitialSignIn = async () => {
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("No initial token provided.");
                }
            } catch (error) {
                console.error("Error with initial sign-in:", error);
            }
        };

        // --- FIRESTORE & USER SETUP ---
        const getAreasCollection = () => collection(db, `artifacts/${appId}/public/data/areas`);
        const getAreaDoc = (id) => doc(db, `artifacts/${appId}/public/data/areas`, id);
        const getUserDoc = (uid) => doc(db, `artifacts/${appId}/users/${uid}/profile`, 'data');
        const getPublicProfilesCollection = () => collection(db, `artifacts/${appId}/public/data/user_profiles`);

        const setupUser = async (user) => {
            const userRef = getUserDoc(user.uid);
            const publicProfileRef = doc(getPublicProfilesCollection(), user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                const profileData = {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email ? user.email.toLowerCase() : null,
                    photoURL: user.photoURL,
                };
                await setDoc(userRef, { ...profileData, friends: [], location: null, currentArea: 'unknown', useGps: true });
                await setDoc(publicProfileRef, profileData);
            }
        };

        // --- MAP & DRAWING LOGIC ---
        function resizeCanvas() {
            if (mapImage.clientWidth > 0) {
                mapCanvas.width = mapImage.clientWidth;
                mapCanvas.height = mapImage.clientHeight;
                redrawAll();
            }
        }

        function getMousePos(evt) {
            const rect = mapCanvas.getBoundingClientRect();
            return { x: (evt.clientX - rect.left) / rect.width, y: (evt.clientY - rect.top) / rect.height };
        }
        
        function drawPolygon(points, color = 'rgba(255, 255, 0, 0.3)', strokeColor = 'rgba(255, 255, 0, 0.7)') {
            if (!points || points.length < 1) return;
            ctx.fillStyle = color;
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            const firstPoint = { x: points[0].x * mapCanvas.width, y: points[0].y * mapCanvas.height };
            ctx.moveTo(firstPoint.x, firstPoint.y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x * mapCanvas.width, points[i].y * mapCanvas.height);
            }
            if (points.length > 2) {
                 ctx.closePath();
                 ctx.fill();
            }
            ctx.stroke();
            ctx.fillStyle = 'yellow';
            points.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x * mapCanvas.width, p.y * mapCanvas.height, 5, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
        
        function redrawAll() {
             ctx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
             for (const areaId in areas) {
                 const area = areas[areaId];
                 if(area && area.polygon) {
                    drawPolygon(area.polygon, 'rgba(29, 78, 216, 0.3)', 'rgba(29, 78, 216, 0.7)');
                 }
             }
             if (isDevMode && currentPolygonPoints.length > 0) {
                 drawPolygon(currentPolygonPoints);
             }
        }

        async function saveArea(name, polygon) {
            try {
                await addDoc(getAreasCollection(), { name, polygon });
                currentPolygonPoints = [];
                redrawAll();
            } catch (error) {
                console.error("Error saving area:", error);
            }
        }
        
        async function deleteArea(areaId) {
            const areaName = areas[areaId]?.name || 'the selected area';
            showConfirm(`Are you sure you want to delete "${areaName}"?`, async () => {
                 try {
                    await deleteDoc(getAreaDoc(areaId));
                } catch (error) {
                    console.error("Error deleting area:", error);
                    showAlert("Could not delete the area.");
                }
            });
        }

        // --- LISTENERS ---
        function attachListeners() {
            cleanupListeners(); 
            unsubscribes.areas = onSnapshot(getAreasCollection(), (snapshot) => {
                areas = {};
                snapshot.forEach(doc => {
                    areas[doc.id] = { id: doc.id, ...doc.data() };
                });
                redrawAll();
                populateLocationsModal();
            });
            unsubscribes.user = onSnapshot(getUserDoc(currentUser.uid), (doc) => {
                if (!doc.exists()) return;
                const userData = doc.data();
                friendsData[currentUser.uid] = userData;
                
                // Update UI based on user data (like GPS toggle)
                const useGps = userData.useGps !== false; // Default to true if undefined
                gpsToggle.checked = useGps;
                checkInBtn.classList.toggle('hidden', useGps);

                const displayName = userData.displayName || "User";
                const photoURL = userData.photoURL || `https://placehold.co/40x40/E0E0E0/757575?text=${displayName.charAt(0)}`;
                userInfoEl.innerHTML = `<img src="${photoURL}" alt="Your avatar" class="w-10 h-10 rounded-full"><span class="font-semibold">${displayName}</span><button id="settings-btn" class="ml-2 text-gray-500 hover:text-gray-800"><i class="fas fa-cog fa-lg"></i></button>`;
                document.getElementById('settings-btn').addEventListener('click', () => showModal('settings-modal'));

                const currentFriendIds = userData.friends || [];
                const existingFriendIds = Object.keys(unsubscribes.friends);
                currentFriendIds.forEach(friendId => {
                    if (!unsubscribes.friends[friendId]) {
                        unsubscribes.friends[friendId] = onSnapshot(getUserDoc(friendId), (friendDoc) => {
                            if (friendDoc.exists()) {
                                friendsData[friendId] = friendDoc.data();
                            } else {
                                delete friendsData[friendId];
                            }
                            updateSquadDisplay();
                        });
                    }
                });
                existingFriendIds.forEach(friendId => {
                    if (!currentFriendIds.includes(friendId)) {
                        unsubscribes.friends[friendId]();
                        delete unsubscribes.friends[friendId];
                        delete friendsData[friendId];
                    }
                });
                updateSquadDisplay();
            });
        }

        function cleanupListeners() {
            if (unsubscribes.areas) unsubscribes.areas();
            if (unsubscribes.user) unsubscribes.user();
            Object.values(unsubscribes.friends).forEach(unsub => unsub());
            unsubscribes = { areas: null, user: null, friends: {} };
            friendsData = {};
        }

        // --- UI UPDATES ---
        function showLoginUI() {
            mainContent.classList.add('hidden');
            loginPrompt.classList.remove('hidden');
            authContainer.innerHTML = `<button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Sign in with Google</button>`;
            document.getElementById('login-btn').addEventListener('click', signIn);
        }

        function showAppUI(user) {
            loginPrompt.classList.add('hidden');
            mainContent.classList.remove('hidden');
            authContainer.innerHTML = `<button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Sign Out</button>`;
            document.getElementById('logout-btn').addEventListener('click', logOut);
            attachButtonListeners();
            resizeCanvas();
        }
        
        function updateSquadDisplay() {
            userMarkersContainer.innerHTML = '';
            squadList.innerHTML = '';
            
            const allUsers = Object.values(friendsData);
            // Sort to put the current user first
            allUsers.sort((a, b) => {
                if (a.uid === currentUser.uid) return -1;
                if (b.uid === currentUser.uid) return 1;
                return (a.displayName || '').localeCompare(b.displayName || '');
            });

            allUsers.forEach(userData => {
                if (!userData || !userData.uid) return;
                if (userData.location) updateUserMarker(userData);
                
                const isCurrentUser = userData.uid === currentUser.uid;
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow-md flex items-center gap-4 border-2 ${isCurrentUser ? 'border-blue-500' : 'border-transparent'}`;
                
                const displayName = userData.displayName || 'Friend';
                const photoURL = userData.photoURL || `https://placehold.co/48x48/E0E0E0/757575?text=${displayName.charAt(0)}`;
                
                card.innerHTML = `
                    <img src="${photoURL}" alt="${displayName}'s avatar" class="w-12 h-12 rounded-full">
                    <div>
                        <p class="font-bold">${displayName} ${isCurrentUser ? '(You)' : ''}</p>
                        <p class="text-sm text-gray-600">Location: <span class="font-semibold text-indigo-600">${userData.currentArea || 'Unknown'}</span></p>
                    </div>`;
                squadList.appendChild(card);
            });
        }
        
        function updateUserMarker(userData) {
             let marker = document.getElementById(`marker-${userData.uid}`);
             const displayName = userData.displayName || 'User';
             const photoURL = userData.photoURL || `https://placehold.co/40x40/E0E0E0/757575?text=${displayName.charAt(0)}`;
             if (!marker) {
                 marker = document.createElement('div');
                 marker.id = `marker-${userData.uid}`;
                 marker.className = 'user-marker';
                 marker.innerHTML = `<img src="${photoURL}" alt="${displayName}'s avatar"><div class="name-label">${displayName.split(' ')[0]}</div>`;
                 userMarkersContainer.appendChild(marker);
             }
             marker.style.left = `${userData.location.x * 100}%`;
             marker.style.top = `${userData.location.y * 100}%`;
        }

        // --- MODAL LOGIC ---
        let confirmCallback = null;
        function showModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            showModal('alert-modal');
        }
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            showModal('confirm-modal');
        }
        document.getElementById('alert-ok').addEventListener('click', () => hideModal('alert-modal'));
        document.getElementById('confirm-cancel').addEventListener('click', () => { confirmCallback = null; hideModal('confirm-modal'); });
        document.getElementById('confirm-ok').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            hideModal('confirm-modal');
        });

        function populateLocationsModal() {
            const listEl = document.getElementById('locations-list');
            listEl.innerHTML = '';
            if (Object.keys(areas).length === 0) {
                listEl.innerHTML = `<p class="text-gray-500">No locations created yet.</p>`;
                return;
            }
            for (const areaId in areas) {
                const area = areas[areaId];
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 border-b';
                item.innerHTML = `<span>${area.name}</span><button data-id="${area.id}" class="delete-area-btn bg-red-500 text-white text-xs py-1 px-2 rounded hover:bg-red-600">Delete</button>`;
                listEl.appendChild(item);
            }
            document.querySelectorAll('.delete-area-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteArea(e.target.dataset.id));
            });
        }

        function populateCheckInModal() {
            const listEl = document.getElementById('check-in-locations-list');
            listEl.innerHTML = '';
            if (Object.keys(areas).length === 0) {
                listEl.innerHTML = `<p class="p-4 text-gray-500">No check-in locations available.</p>`;
                return;
            }
            Object.values(areas).forEach(area => {
                const item = document.createElement('div');
                item.className = 'p-4 border-b last:border-b-0 hover:bg-gray-100 cursor-pointer';
                item.textContent = area.name;
                item.dataset.areaId = area.id;
                item.addEventListener('click', handleCheckIn);
                listEl.appendChild(item);
            });
        }

        async function handleCheckIn(e) {
            const areaId = e.target.dataset.areaId;
            const area = areas[areaId];
            if (!area || !area.polygon) return;

            // Calculate centroid of the polygon to place the marker
            let cx = 0, cy = 0;
            area.polygon.forEach(p => {
                cx += p.x;
                cy += p.y;
            });
            const centroid = {
                x: cx / area.polygon.length,
                y: cy / area.polygon.length,
            };

            await updateDoc(getUserDoc(currentUser.uid), {
                location: centroid,
                currentArea: area.name
            });

            hideModal('check-in-modal');
        }

        // --- EVENT HANDLERS ---
        let listenersAttached = false;
        function attachButtonListeners() {
            if (listenersAttached) return; 
            
            document.getElementById('dev-mode-btn').addEventListener('click', () => showModal('passcode-modal'));
            document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
            document.getElementById('cancel-drawing-btn').addEventListener('click', () => {
                isDevMode = false;
                currentPolygonPoints = [];
                devPanel.classList.add('hidden');
                redrawAll();
            });

            document.getElementById('passcode-cancel').addEventListener('click', () => hideModal('passcode-modal'));
            document.getElementById('passcode-submit').addEventListener('click', () => {
                if (document.getElementById('passcode-input').value === '1979') {
                    hideModal('passcode-modal');
                    populateLocationsModal();
                    showModal('locations-modal');
                } else {
                    showAlert("Incorrect passcode.");
                }
                document.getElementById('passcode-input').value = '';
            });

            document.getElementById('locations-close').addEventListener('click', () => hideModal('locations-modal'));
            document.getElementById('add-new-location-btn').addEventListener('click', () => {
                hideModal('locations-modal');
                isDevMode = true;
                devPanel.classList.remove('hidden');
            });

            document.getElementById('area-name-cancel').addEventListener('click', () => {
                hideModal('area-name-modal');
                currentPolygonPoints = [];
                redrawAll();
            });
            document.getElementById('area-name-submit').addEventListener('click', () => {
                const name = document.getElementById('area-name-input').value;
                if (name && currentPolygonPoints.length > 2) {
                    saveArea(name, currentPolygonPoints);
                    hideModal('area-name-modal');
                    document.getElementById('area-name-input').value = '';
                    isDevMode = false;
                    devPanel.classList.add('hidden');
                } else {
                    showAlert("Please enter a valid name for the area.");
                }
            });

            document.getElementById('add-friend-cancel').addEventListener('click', () => hideModal('add-friend-modal'));
            document.getElementById('add-friend-submit').addEventListener('click', async () => {
                const friendEmail = document.getElementById('add-friend-input').value;
                if (!friendEmail) return;
                try {
                    const profilesRef = getPublicProfilesCollection();
                    const q = query(profilesRef, where("email", "==", friendEmail.toLowerCase()));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        showAlert("User not found. Please make sure they have signed into the app at least once and you have entered the correct email.");
                        return;
                    }
                    let friendUid = null;
                    querySnapshot.forEach((doc) => { friendUid = doc.data().uid; });
                    if (friendUid && friendUid !== currentUser.uid) {
                        const userRef = getUserDoc(currentUser.uid);
                        await updateDoc(userRef, { friends: arrayUnion(friendUid) });
                        showAlert("Friend added successfully!");
                    } else if (friendUid === currentUser.uid) {
                        showAlert("You can't add yourself as a friend!");
                    }
                } catch (error) {
                    console.error("Error adding friend:", error);
                    showAlert("There was an error trying to add your friend.");
                }
                document.getElementById('add-friend-input').value = '';
                hideModal('add-friend-modal');
            });
            
            mapCanvas.addEventListener('click', (evt) => {
                if (!isDevMode) return;
                const pos = getMousePos(evt);
                if (currentPolygonPoints.length > 2) {
                    const firstPoint = currentPolygonPoints[0];
                    const clickRadius = 10 / mapCanvas.width;
                    if (Math.hypot(pos.x - firstPoint.x, pos.y - firstPoint.y) < clickRadius) {
                        showModal('area-name-modal');
                        return;
                    }
                }
                currentPolygonPoints.push(pos);
                redrawAll();
            });

            // New Listeners
            document.getElementById('settings-close').addEventListener('click', () => hideModal('settings-modal'));
            gpsToggle.addEventListener('change', async (e) => {
                await updateDoc(getUserDoc(currentUser.uid), { useGps: e.target.checked });
            });
            checkInBtn.addEventListener('click', () => {
                populateCheckInModal();
                showModal('check-in-modal');
            });
            document.getElementById('check-in-cancel').addEventListener('click', () => hideModal('check-in-modal'));

            listenersAttached = true;
        }

        // --- LOCATION UPDATES ---
        function mockLocationUpdate() {
            if (!currentUser || !friendsData[currentUser.uid] || !friendsData[currentUser.uid].useGps) return;
            
            const oldAreaName = friendsData[currentUser.uid].currentArea;
            const newLocation = { x: Math.random(), y: Math.random() };
            let newAreaName = 'The Wilds';
            for (const areaId in areas) {
                const area = areas[areaId];
                if (area && area.polygon && isPointInPolygon(newLocation, area.polygon)) {
                    newAreaName = area.name;
                    break;
                }
            }
            
            if (newAreaName !== oldAreaName) {
                console.log(`Moved into new zone: ${newAreaName}`);
            }
            
            const userRef = getUserDoc(currentUser.uid);
            updateDoc(userRef, { location: newLocation, currentArea: newAreaName });
        }
        
        function isPointInPolygon(point, polygon) {
            if (!polygon) return false;
            let isInside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i].x, yi = polygon[i].y;
                const xj = polygon[j].x, yj = polygon[j].y;
                const intersect = ((yi > point.y) !== (yj > point.y)) && (point.x < (xj - xi) * (point.y - yi) / (yj - yi) + xi);
                if (intersect) isInside = !isInside;
            }
            return isInside;
        }

        // --- LIFECYCLE ---
        window.addEventListener('resize', resizeCanvas);
        window.onload = async () => {
            await attemptInitialSignIn();
            mapImage.onload = () => resizeCanvas();
            if (mapImage.complete) resizeCanvas();
            setInterval(() => {
                if (currentUser) mockLocationUpdate();
            }, 5000);
        };

    </script>
</body>
</html>
